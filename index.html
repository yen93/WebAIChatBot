<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebAIChatBot - Messenger View</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f0f2f5; /* Light background for the whole page */
        }
        
        /* ---------------------------------- */
        /* BASE & LAYOUT STYLES (FROM ORIGINAL) */
        /* ---------------------------------- */

        .container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .box {
            display: flex;
            flex-direction: column;
            min-height: 90vh; 
            width: 50%;
            border: 1px solid #ddd;
            padding: 0; /* Remove padding here to allow chat content to fill the space */
            box-sizing: border-box;
            background-color: white; /* White background for the boxes */
            border-radius: 8px; /* Rounded corners */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        h1 {
            padding: 20px;
            margin: 0;
            font-size: 1.5em;
            border-bottom: 1px solid #eee;
            background-color: #f7f7f7;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        textarea, input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none; /* Prevent manual resize */
        }

        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            flex-shrink: 0; /* Prevents button from shrinking in a flex container */
        }
        button:hover {
            background-color: #0056b3;
        }

        /* ---------------------------------- */
        /* CHAT BOX SPECIFIC STYLES */
        /* ---------------------------------- */

        #chat-box-content {
            /* This section is the new, main chat display area */
            flex-grow: 1; /* Allows it to take up all available vertical space */
            padding: 10px;
            overflow-y: auto; /* The scrollbar for the messages */
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .chat-header-text {
            padding: 0 20px 10px;
            margin: 0;
            color: #606770;
            font-size: 0.9em;
        }

        .message {
            max-width: 70%; /* Messages don't span the whole width */
            padding: 8px 12px;
            border-radius: 18px; /* Classic messenger bubble shape */
            line-height: 1.4;
            word-wrap: break-word; /* Ensure long words wrap */
            margin: 0; /* Reset default margins */
        }

        .user-message {
            background-color: #007bff; /* Blue for the user */
            color: white;
            align-self: flex-end; /* Push to the right */
            border-bottom-right-radius: 4px; /* Flatter edge near the bottom */
        }

        .ai-message {
            background-color: #e4e6eb; /* Light grey for the bot */
            color: #1c1e21;
            align-self: flex-start; /* Stay on the left */
            border-bottom-left-radius: 4px; /* Flatter edge near the bottom */
        }

        /* The original displayBox is now a hidden area for script handling, 
           but the chat messages will be dynamically added to #chat-box-content */
        #displayBox { display: none; } 

        .box {
            margin-top: 20px;
            /* Set a fixed height so the content can exceed it */
            height: 400px; /* Adjust this height as needed */
            
            /* The key property: enables vertical scrolling when content overflows */
            overflow-y: auto; 
            
            /* Optional: Add padding/border for visual separation */
            padding: 10px;
            border: 1px solid #ccc;
        }

        .chat-input-area {
            /* This is the equivalent of the original .bottomStyle but styled for a modern input bar */
            padding: 10px 20px;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            background-color: #fff;
            gap: 10px;
            flex-shrink: 0; /* Important: prevents the input area from shrinking */
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        #inputBox {
            /* Input box in the chat area */
            height: 40px; 
            margin: 0; /* Remove previous margins */
            flex-grow: 1; /* Takes up most of the horizontal space */
            border-radius: 20px;
        }
        
        .chat-input-area button {
            /* Send button in the chat area */
            width: 80px;
            padding: 8px 15px;
            border-radius: 20px;
        }

        /* ---------------------------------- */
        /* KNOWLEDGE BASE SPECIFIC STYLES */
        /* ---------------------------------- */
        
        #data-display {
            flex-grow: 1; /* Takes up all available space */
            height: auto; /* Let flex control the height */
            overflow-y: auto; 
            padding: 20px;
        }

        .kb-bottomStyle {
            padding: 10px 20px 20px 20px;
            border-top: 1px solid #eee;
            background-color: #f7f7f7;
            flex-shrink: 0;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        #KBinputBox {
            height: 80px; 
            margin-bottom: 5px; 
        }

        /* Table styles remain mostly the same */
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: left; }
        th { background-color: #e9ebee; font-weight: 600; }
        
        /* ---------------------------------- */
        /* MEDIA QUERY (PHONE VIEW) */
        /* ---------------------------------- */
        @media (max-width: 600px) {
            .container { flex-direction: column; }
            .box { flex: none; width: 100%; margin-bottom: 10px; height: 50vh; }
            .chat-input-area { padding: 10px; }
        }
    </style>
</head>
<body>

    <div>
        <p>This is a sample AI chatbot using Yen's KB API. This can be integrated as a feature in your website.</p>
    </div>

    <div class="container">
        <div class="box">
            <h1>Company KB Chatbot ðŸ’¬</h1>

            <p class="chat-header-text">Hi! How may I help you today? (Type your message below)</p>
            
            <div id="chat-box-content">
                <p class="message ai-message">Welcome! I'm your Company Knowledge Bot. Ask me anything about our policies, products, or services!</p>
            </div>
            
            <textarea id="displayBox" readonly style="display: none;" placeholder="Response will appear here..."></textarea>
            
            <div class="chat-input-area">
                <textarea id="inputBox" placeholder='Enter your message here...'></textarea>
                <button onclick="sendRequest()">Send</button>
            </div>
        </div>
        
        <div class="box">
            <h1>Knowledge Base ðŸ“š</h1>
            <div id="data-display">
                Loading data...
            </div> 
            <div class="kb-bottomStyle">
                <p>Add to Knowledge Base:</p>
                <textarea id="KBinputBox" placeholder='Enter new KB info here.'></textarea>
                <button onclick="AddToKnowledgeBase()">Add</button>
            </div>
        </div>
    </div>

    
    <script>
        const API_URL = "https://fqsapi.onrender.com/FireBaseFQS/GetChatResponse";
        const CHAT_CONTENT = document.getElementById('chat-box-content');
        const DISPLAY_BOX = document.getElementById('displayBox'); // Hidden box for raw response

        /**
         * Renders a message bubble in the chat view.
         * @param {string} text - The message content.
         * @param {string} type - 'user' or 'ai'.
         */
        function renderMessage(text, type) {
            const messageElement = document.createElement('p');
            messageElement.classList.add('message');
            if (type === 'user') {
                messageElement.classList.add('user-message');
            } else {
                messageElement.classList.add('ai-message');
            }
            messageElement.textContent = text;
            CHAT_CONTENT.appendChild(messageElement);

            // Scroll to the bottom of the chat history
            CHAT_CONTENT.scrollTop = CHAT_CONTENT.scrollHeight;
        }


        /**
         * Sends the user's message as a POST request and displays the AI's response in a bubble.
         */
        async function sendRequest() {
            const inputBox = document.getElementById('inputBox');
            const userMessage = inputBox.value.trim();

            if (!userMessage) {
                renderMessage("Error: Please enter a message.", 'ai');
                return;
            }

            // 1. Display User Message immediately
            renderMessage(userMessage, 'user');
            
            // Clear the input box after sending
            inputBox.value = ''; 
            
            // Show a temporary 'thinking' message
            const thinkingMessage = document.createElement('p');
            thinkingMessage.classList.add('message', 'ai-message');
            thinkingMessage.textContent = "AI is thinking...";
            CHAT_CONTENT.appendChild(thinkingMessage);
            CHAT_CONTENT.scrollTop = CHAT_CONTENT.scrollHeight;

            const jsonString = JSON.stringify(userMessage);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: jsonString
                });

                // Get the raw text of the response
                const responseText = await response.text();
                
                // Remove the 'thinking' message
                CHAT_CONTENT.removeChild(thinkingMessage);

                if (!response.ok) {
                    const errorMessage = `HTTP Error ${response.status}: Failed to get response. Raw: ${responseText.substring(0, 50)}...`;
                    renderMessage(errorMessage, 'ai');
                    DISPLAY_BOX.value = errorMessage; // Keep raw in the hidden box
                } else {
                    // Try to parse the response as JSON (if it returns a simple string, it might still be valid)
                    let finalResponse = responseText.trim();
                    try {
                        const jsonResponse = JSON.parse(responseText);
                        // Assuming the API returns a simple string response or a JSON object with a 'response' field
                        finalResponse = jsonResponse.response || finalResponse; 
                    } catch (e) {
                        // If parsing fails, use the raw text as the response
                    }

                    renderMessage(finalResponse, 'ai');
                    DISPLAY_BOX.value = responseText;
                }

            } catch (error) {
                // Remove the 'thinking' message
                if(CHAT_CONTENT.contains(thinkingMessage)) {
                    CHAT_CONTENT.removeChild(thinkingMessage);
                }
                const errorMessage = `Network Error: ${error.message}.`;
                renderMessage(errorMessage, 'ai');
                DISPLAY_BOX.value = errorMessage;
                console.error("Fetch failed:", error);
            }
        }

        // --- Knowledge Base Functions (Kept from original) ---

        const API_AddToKnowledgeBase = "https://fqsapi.onrender.com/FireBaseFQS/AddToKnowledgeBase";
        async function AddToKnowledgeBase() {
            const inputBox = document.getElementById('KBinputBox');
            const requestBody = inputBox.value.trim();
            const jsonString = JSON.stringify(requestBody);

            if (!jsonString) {
                inputBox.value = "Error: Input box is empty.";
                return;
            }

            inputBox.value = "Sending request...";

            try {
                JSON.parse(jsonString); // Quick check before sending
            } catch (e) {
                inputBox.value = `Error: Please make sure your string is not empty. (Details: ${e.message})`;
                return;
            }

            try {
                const response = await fetch(API_AddToKnowledgeBase, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: jsonString
                });

                const responseText = await response.text();
                
                if (response.ok) {
                    inputBox.value = "Success! Refreshing...";
                    setTimeout(() => {
                        location.reload();
                    }, 1000); 
                } else {
                    inputBox.value = `HTTP Error ${response.status} (${response.statusText}):\n\n${responseText}`;
                }

            } catch (error) {
                inputBox.value = `Network or Fetch Error: ${error.message}.`;
                console.error("Fetch failed:", error);
            }
        }
    
        const API_GetKnowledgeBaseL = "https://fqsapi.onrender.com/FireBaseFQS/GetKnowledgeBase";
        const DATA_CONTAINER = document.getElementById('data-display');

        async function fetchAndDisplayData() {
            try {
                const response = await fetch(API_GetKnowledgeBaseL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({}) 
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json(); 
                renderTable(data);

            } catch (error) {
                console.error("Error fetching or rendering data:", error);
                DATA_CONTAINER.innerHTML = `Error loading data: ${error.message}`;
            }
        }
        
        function renderTable(data) {
            if (!data || data.length === 0) {
                DATA_CONTAINER.innerHTML = "<p>No knowledge base entries found.</p>";
                return;
            }

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Information</th>
                            <th>Date Added</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(item => {
                const formattedDate = new Date(item.DateAdded).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric'
                });

                tableHTML += `
                    <tr>
                        <td>${item.ID}</td>
                        <td>${item.Info}</td>
                        <td>${formattedDate}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            DATA_CONTAINER.innerHTML = tableHTML;
        }

        // Run the function when the page is loaded
        window.onload = fetchAndDisplayData; 
    
    </script>

</body>
</html>

